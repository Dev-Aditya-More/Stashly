name: ðŸ“¦ Send APK via Discord on Release

on:
  release:
    types: [ published ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  distributeApk:
    name: Send APK to Discord
    runs-on: ubuntu-latest

    steps:
      - name: Download latest APK from release
        uses: robinraju/release-downloader@v1
        with:
          latest: true
          fileName: "*.apk"
          out-file-path: apk-download
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify APK exists
        id: verify_apk
        run: |
          if ls apk-download/*.apk 1> /dev/null 2>&1; then
            FILE=$(ls apk-download/*.apk | head -n 1)
            BASENAME=$(basename "$FILE")
            echo "APK_FILE=$BASENAME" >> $GITHUB_ENV
            echo "DOWNLOAD_LINK=https://github.com/${{ github.repository }}/releases/latest/download/$BASENAME" >> $GITHUB_ENV
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No APK found in release assets"
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Abort if APK missing
        if: steps.verify_apk.outputs.found != 'true'
        run: exit 1

      - name: Send release link to Discord
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-title: "âœ… New Pokeverse Release"
          embed-description: |
            **A new version of Pokeverse is live!**

            ðŸ‘‰ [Click here to download the APK](${{ env.DOWNLOAD_LINK }})
          embed-image-url: "https://github.com/Dev-Aditya-More/PokeVerse/blob/master/app/src/main/res/drawable/logo.png?raw=true"
          wait: true